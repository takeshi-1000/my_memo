## 背景

iOS(MacOSも含むかも?)に関連するスレッド技術系をまとめるために作成

## cpuコアについての話

コンピュータの初期には、処理できる最大量がcpuのクロック速度に決まっていたが、プロセッサがよりコンパクトな設計になるにつれ、物理的な制約からクロック速度を高めることができず小さくなってしまった。
そこで各チップメーカーが考え出した概念が、マルチコアというもので、物理的な制約はそのままに一つのcpuが実行する処理の単位（コア）を増やし、1秒当たりの命令量を増やすという考え方だった。
その一方で、アプリケーションの側から現状使用できるスレッドを確認して、その複数コアに対してスレッドを作成し、スケジュールしたり相互に干渉しないようにプログラミングするのはあまり現実的でない。

## スレッドの必要性

- スレッドが一つの場合だと、その一つのスレッドでプログラムを処理する必要が出てくる
- 仮に大量の計算が必要な処理の場合にスレッドが一つしかないと、タッチイベントも受け取れずユーザーからしたらアプリケーションが止まっているかのように感じてしまう。
- そういったユーザーがインタラクティブに操作すべき処理を専用のスレッド（いわゆるメインスレッド）で処理させ、そうでないカスタムの計算処理などを別のスレッドで実行させることで、アプリケーションの応答性を高める

### サンプルコード

スレッド一つしかできない極端なコード

```
struct runroopTestApp: App {
    var body: some Scene {
        WindowGroup {
            Button("hello") {
                 print("hello world")
            }
            
            Button("test") {
                Thread.sleep(forTimeInterval: 10)
                print("aaa")
                print(Thread.isMainThread)
            }
        }
    }
}
```

スレッド複数の場合の極端なコード
（Buttonタップした後も、helloがタップできることを示せれば良い）

```
struct runroopTestApp: App {
    var body: some Scene {
        WindowGroup {
            Button("hello") {
                 print("hello world")
            }
            
            Button("test") {
                Thread.detachNewThread {
                    Thread.sleep(forTimeInterval: 10)
                    print("aaa")
                    print(Thread.isMainThread)
                }
            }
        }
    }
}
```

## スレッドで考慮すべき点、デメリット

- 単一のアプリケーション内では、スレッドは同じメモリ空間を共有するのでデータの不整合が生じないように、プログラムする必要が出てくる
- 単一のスレッドに比べて、実行できるパスを増やすため相対的にコードが複雑になり状態を管理するのが大変

## スレッドの代替案

スレッドそのものは極めて低レベルなので、それを作成して扱うことは極めて難易度が高い。なのでそうしたハードルを下げたスレッド置換の技術を使うことが必要である。

### hoge

### hoge

### hoge

### hoge

## スレッドメモ

- スレッドが現在実行されいていない場合は下記の感じ
・ブロックされて入力を待機しているか
・入力の準備ができているがまだ実行するようにスケジュールされていない
- あああ
ああ
あああ


## スレッドメモ

## 実行ループ


## 参考リンク

https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW1
https://suelan.github.io/2021/02/13/20210213-dive-into-runloop-ios/
