# 概要 - swiftからswift製のモジュールを使う

import module の理解を深めるためのメモ。
まずはswiftからswiftを使う例から。

## 使うベースファイル

```
main.swift

print("Hello")
let _ = Hoge()

```

```
hoge.swift

class Hoge {

  init() {
     print("Hoge init")
  }
}

```

### 実験1

swiftcコンパイラドライバに、複数のswiftファイルを渡す

#### 結果

- 実行バイナリ（Executable File）作成できた
- 実行バイナリを実行して、プログラムができた。

```
[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift hoge.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls
hoge.swift	main		main.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ./main 
Hello
Hoge init

```


### 実験2

実験1で使用したswiftファイルをそれぞれコンパイルした後に、Executable File を作れるか確認

- main.swift, hoge.swift それぞれオブジェクトファイルとしてコンパイルして、結合

#### 結果

- main.o のコンパイル(オブジェクトファイルへの変換)ができない
  - モジュールの方法しかないんだっけ?多分そうだが、もう少し論理的に説明したい。
- hoge.swiftはコンパイルできる(他からの参照がないのでイメージつく)
- hoge.swiftのバイナリと、main.swiftを入力として、結合はできない

```
[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc -c -o main.o main.swift
main.swift:2:9: error: cannot find 'Hoge' in scope
let _ = Hoge()
        ^~~~

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc -c -o hoge.o hoge.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc hoge.o main.swift
main.swift:2:9: error: cannot find 'Hoge' in scope
let _ = Hoge()
        ^~~~

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls
hoge.o		hoge.swift		main.swift
```

### 実験3

hoge.swift側をモジュール化してみる

※ここでソースコードを下記のように変更

```
main.swift

import Hoge

print("Hello")
let _ = Hoge()

```

```
hoge.swift

public class Hoge {

  public init() {
     print("Hoge init")
  }
}

```
↑ public にする理由深掘り

#### アプローチ1

hoge.swiftをモジュール化し、オブジェクトファイルとして結合させる

#### 結果

```
[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift
main.swift:1:8: error: no such module 'Hoge'
import Hoge
       ^

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc -emit-module hoge.swift -module-name Hoge

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls
Hoge.abi.json		Hoge.swiftdoc		Hoge.swiftmodule	Hoge.swiftsourceinfo	hoge.swift		main.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift                               
main.swift:1:8: error: no such module 'Hoge'
import Hoge
       ^

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift -I .
error: link command failed with exit code 1 (use -v to see invocation)
Undefined symbols for architecture arm64:
  "_$s4HogeAACABycfC", referenced from:
      _main in main-1.o
  "_$s4HogeAACMa", referenced from:
      _main in main-1.o
ld: symbol(s) not found for architecture arm64

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc -emit-object hoge.swift -module-name Hoge

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls
Hoge.abi.json		Hoge.swiftdoc		Hoge.swiftmodule	Hoge.swiftsourceinfo	hoge.o			hoge.swift		main.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift -I ./hoge.o
main.swift:1:8: error: no such module 'Hoge'
import Hoge
       ^

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift hoge.o -I .
error: link command failed with exit code 1 (use -v to see invocation)
duplicate symbol '_main' in:
    /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.DcrlBu/main-1.o
    hoge.o
ld: 1 duplicate symbol for architecture arm64

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ nm main.swift
/Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/nm: error: main.swift: The file was not recognized as a valid object file


[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls 
Hoge.abi.json		Hoge.swiftdoc		Hoge.swiftmodule	Hoge.swiftsourceinfo	hoge.o			hoge.swift		main.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ nm hoge.o
0000000000000008 T _$s4HogeAACABycfC
00000000000003e8 S _$s4HogeAACABycfCTq
0000000000000040 T _$s4HogeAACABycfc
00000000000003f8 s _$s4HogeAACMF
0000000000000230 T _$s4HogeAACMa
00000000000002a8 d _$s4HogeAACMf
0000000000000280 D _$s4HogeAACMm
00000000000003b4 S _$s4HogeAACMn
00000000000002b8 D _$s4HogeAACN
00000000000001f4 T _$s4HogeAACfD
00000000000001d0 T _$s4HogeAACfd
00000000000003a8 S _$s4HogeMXM
                 U _$sBoWV
                 U _$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC
                 U _$sSSN
0000000000000250 T _$sSa12_endMutationyyF
                 U _$sSaMa
                 U _$ss27_allocateUninitializedArrayySayxG_BptBwlF
000000000000011c T _$ss27_finalizeUninitializedArrayySayxGABnlF
                 U _$ss5print_9separator10terminatoryypd_S2StF
0000000000000178 T _$ss5print_9separator10terminatoryypd_S2StFfA0_
00000000000001a4 T _$ss5print_9separator10terminatoryypd_S2StFfA1_
                 U _$sypN
                 U _OBJC_CLASS_$__TtCs12_SwiftObject
                 U _OBJC_METACLASS_$__TtCs12_SwiftObject
0000000000000358 s __DATA__TtC4Hoge4Hoge
0000000000000310 s __METACLASS_DATA__TtC4Hoge4Hoge
00000000000003f0 S ___swift_reflection_version
                 U __objc_empty_cache
0000000000000000 T _main ❗️❗️❗️❗️ => mainシンボルが含まれてしまう。main関数は一つしか存在しない
0000000000000420 s _objc_classes_$s4HogeAACN
                 U _objc_opt_self
                 U _swift_allocObject
                 U _swift_bridgeObjectRelease
                 U _swift_bridgeObjectRetain
                 U _swift_deallocClassInstance
00000000000003f2 S _symbolic _____ 4HogeAAC
0000000000000408 s l_$s4HogeAACHn
000000000000025c s l___unnamed_1
0000000000000277 s l___unnamed_2
0000000000000275 s l___unnamed_3
0000000000000266 s l___unnamed_4
00000000000003a0 s l___unnamed_5
000000000000027c s l_entry_point
000000000000040c s l_llvm.swift_module_hash
0000000000000000 t ltmp0
000000000000025c s ltmp1
0000000000000420 s ltmp10
0000000000000428 s ltmp11
0000000000000430 s ltmp12
000000000000027c s ltmp2
0000000000000280 d ltmp3
0000000000000310 s ltmp4
00000000000003a0 s ltmp5
00000000000003f2 s ltmp6
00000000000003f8 s ltmp7
0000000000000408 s ltmp8
000000000000040c s ltmp9

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift hoge.o -I . -v
Apple Swift version 5.6.1 (swiftlang-5.6.0.323.66 clang-1316.0.20.12)
Target: arm64-apple-macosx12.0
/Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-frontend -frontend -c -primary-file main.swift -target arm64-apple-macosx12.0 -Xllvm -aarch64-use-tbi -enable-objc-interop -stack-check -sdk /Applications/Xcode13.4.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX12.3.sdk -I . -color-diagnostics -new-driver-path /Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-driver -resource-dir /Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift -module-name main -target-sdk-version 12.3 -o /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.s4g1GF/main-1.o
/Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/ld /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.s4g1GF/main-1.o hoge.o /Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/clang/lib/darwin/libclang_rt.osx.a -syslibroot /Applications/Xcode13.4.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX12.3.sdk -lobjc -lSystem -arch arm64 -L /Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/macosx -L /Applications/Xcode13.4.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX12.3.sdk/usr/lib/swift -platform_version macos 12.0.0 12.3.0 -o main
error: link command failed with exit code 1 (use -v to see invocation)
duplicate symbol '_main' in:
    /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.s4g1GF/main-1.o
    hoge.o
ld: 1 duplicate symbol for architecture arm64

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ nm /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.s4g1GF/main-1.o
/Applications/Xcode13.4.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/nm: error: /var/folders/4c/0qwhzzgx3q1_455_mgl56x080000gp/T/TemporaryDirectory.s4g1GF/main-1.o: No such file or directory

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc -emit-object hoge.swift -module-name Hoge -parse-as-library

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ nm hoge.o
0000000000000000 T _$s4HogeAACABycfC
00000000000003e0 S _$s4HogeAACABycfCTq
0000000000000038 T _$s4HogeAACABycfc
00000000000003f0 s _$s4HogeAACMF
0000000000000228 T _$s4HogeAACMa
00000000000002a0 d _$s4HogeAACMf
0000000000000278 D _$s4HogeAACMm
00000000000003ac S _$s4HogeAACMn
00000000000002b0 D _$s4HogeAACN
00000000000001ec T _$s4HogeAACfD
00000000000001c8 T _$s4HogeAACfd
00000000000003a0 S _$s4HogeMXM
                 U _$sBoWV
                 U _$sSS21_builtinStringLiteral17utf8CodeUnitCount7isASCIISSBp_BwBi1_tcfC
                 U _$sSSN
0000000000000248 T _$sSa12_endMutationyyF
                 U _$sSaMa
                 U _$ss27_allocateUninitializedArrayySayxG_BptBwlF
0000000000000114 T _$ss27_finalizeUninitializedArrayySayxGABnlF
                 U _$ss5print_9separator10terminatoryypd_S2StF
0000000000000170 T _$ss5print_9separator10terminatoryypd_S2StFfA0_
000000000000019c T _$ss5print_9separator10terminatoryypd_S2StFfA1_
                 U _$sypN
                 U _OBJC_CLASS_$__TtCs12_SwiftObject
                 U _OBJC_METACLASS_$__TtCs12_SwiftObject
0000000000000350 s __DATA__TtC4Hoge4Hoge
0000000000000308 s __METACLASS_DATA__TtC4Hoge4Hoge
00000000000003e8 S ___swift_reflection_version
                 U __objc_empty_cache
0000000000000418 s _objc_classes_$s4HogeAACN
                 U _objc_opt_self
                 U _swift_allocObject
                 U _swift_bridgeObjectRelease
                 U _swift_bridgeObjectRetain
                 U _swift_deallocClassInstance
00000000000003ea S _symbolic _____ 4HogeAAC
0000000000000400 s l_$s4HogeAACHn
0000000000000254 s l___unnamed_1
000000000000026f s l___unnamed_2
000000000000026d s l___unnamed_3
000000000000025e s l___unnamed_4
0000000000000398 s l___unnamed_5
0000000000000404 s l_llvm.swift_module_hash
0000000000000000 t ltmp0
0000000000000254 s ltmp1
0000000000000420 s ltmp10
0000000000000428 s ltmp11
0000000000000278 d ltmp2
0000000000000308 s ltmp3
0000000000000398 s ltmp4
00000000000003ea s ltmp5
00000000000003f0 s ltmp6
0000000000000400 s ltmp7
0000000000000404 s ltmp8
0000000000000418 s ltmp9

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ swiftc main.swift hoge.o -I .                                                         

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ls     
Hoge.abi.json		Hoge.swiftmodule	hoge.o			main
Hoge.swiftdoc		Hoge.swiftsourceinfo	hoge.swift		main.swift

[takeshikomori@MacBook-Pro-2:~/me/takeshi-1000/testCompile/testCompile6]
$ ./main 
Hello
Hoge init
```

##### 複数ファイルの場合は?

#### アプローチ2

hoge.swiftをモジュール化し、静的ライブラリとして結合させる

#### アプローチ3

hoge.swiftをモジュール化し、動的ライブラリとして結合させる

#### アプローチ4

hoge.swiftをXcFrameworkを作成
動的ライブラリ、静的ライブラリ

aaa


##### 小ネタ

モジュールをテキストにするか、バイナリにするか

===

# 概要 - swiftからobjective-c製のモジュールを使う

import module の理解を深めるためのメモ。
swiftからobjective-cを使う例から。
その他 `HogeViewController: UIViewController` など

===

# 概要 - objective-cからswift製のモジュールを使う

===

# 概要 - objective-cからobjective-c製のモジュールを使う

===

## 参考

https://qiita.com/omochimetaru/items/428324ed8bcd2b98dacb
https://clang.llvm.org/docs/Modules.html
https://qiita.com/rintaro/items/3ad640e3938207218c20
https://developer.apple.com/videos/play/wwdc2018/415/

## メモ

clang module の仕組みがなぜc言語のプリコンパイル済みヘッダよりも良いのか深掘りしたい。
